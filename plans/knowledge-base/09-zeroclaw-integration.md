# AES Knowledge Base — ZeroClaw Integration Guide

## Overview

ZeroClaw is the agent runtime used by AES. It is an **existing open-source Rust binary** maintained by zeroclaw-labs. AES does NOT reimplement ZeroClaw — it integrates with it.

**GitHub**: github.com/zeroclaw-labs/zeroclaw
**License**: Apache 2.0 / MIT

## Key Facts

- Binary size: ~8.8MB
- RAM per agent: <5MB at idle
- Cold start: milliseconds
- Architecture: trait-driven (providers, channels, tools, memory are all swappable)

## ZeroClaw Configuration

Each agent gets its own `config.toml`. The backend generates this file at agent spawn time.

**Configuration file location**: `{workspacePath}/zeroclaw.config.toml`

```toml
[runtime]
kind = "native"  # or "docker" for sandboxed

[providers]
default = "ollama"
# or "openai-codex", "anthropic", custom endpoint

[channels]
# Slack channel configuration
[[channels.slack]]
token = "xoxb-..."
channel_id = "C12345"

[memory]
backend = "sqlite"  # hybrid vector + FTS5 search
path = "{workspacePath}/memory/brain.db"  # actual filename from ZeroClaw source

[observability]
runtime_trace_mode = "rolling"   # none | rolling | full
runtime_trace_path = "{workspacePath}/state/runtime-trace.jsonl"

[cost]
enabled = true
# daily_limit_usd = 5.0
# monthly_limit_usd = 50.0

[security]
# Explicit filesystem scope
workspace = "{workspacePath}"
# Channel allowlists (deny-by-default)

[identity]
format = "aieos"  # uses AIEOS v1.1 JSON
path = "{workspacePath}/identity.json"

# Soul/persona is loaded separately (Markdown)
soul_path = "{workspacePath}/soul.md"
```

## AIEOS v1.1 Identity Format

ZeroClaw natively supports AIEOS v1.1. The spec has 5 components:

1. **Identity & Physicality** — biographical data, physical presence descriptors
2. **Psychology & Neural Matrix** — OCEAN traits, moral alignment, normalized 0.0–1.0 drives
3. **Linguistics & Idiolect** — vocal style, syntax patterns, verbal tics
4. **History & Motivations** — origin, life events, long-term goals
5. **Capabilities & Skills** — tools available, priority scale 1–10

**Schema URL**: `https://aieos.org/schema/v1.1/aieos.schema.json`

## ZeroClaw Commands (Used by AES)

| Command | Purpose |
|---------|---------|
| `zeroclaw daemon` | Start long-running autonomous agent |
| `zeroclaw gateway --port <n>` | Start webhook server for task injection |
| `zeroclaw onboard --api-key --provider --model` | Configure agent credentials |
| `zeroclaw service install` | Register as background service |
| `zeroclaw status` | Check agent health |
| `zeroclaw agent -m "text"` | Send single message to agent |

## Agent Spawn Process (NestJS → ZeroClaw)

```
1. NestJS generates {workspacePath}/zeroclaw.config.toml
2. NestJS generates {workspacePath}/identity.json (AIEOS v1.1)
3. NestJS copies soul.md to {workspacePath}/soul.md
4. NestJS spawns: child_process.spawn('zeroclaw', ['daemon'], { cwd: workspacePath, env: { AES_PROJECT_ID, AES_STORY_ID, ... } })
5. NestJS captures stdout/stderr streams
6. NestJS stores PID in AgentInstance MongoDB document
```

## Signal Handling

Per the PRD design, AES uses SIGUSR1 to wake agents:
- ZeroClaw handles graceful shutdown on SIGTERM/SIGINT
- AES extends this with SIGUSR1 for task injection wake-up
- Backend also supports sending tasks via ZeroClaw gateway API

## ZeroClaw Gateway API

ZeroClaw exposes a local webhook server when `zeroclaw gateway` is running:
- Default: `http://127.0.0.1:42617`
- Each agent instance runs its own gateway on a different port
- NestJS can POST task payloads to the gateway instead of (or in addition to) SIGUSR1

## Stdout/Stderr Capture

NestJS captures and processes ZeroClaw output:
- **Stdout**: Agent reasoning outputs, tool results
- **Stderr**: System logs (wake events, errors, diagnostics)
- Backend tags each line with `{ runId, ticketId, agentInstanceId }` before broadcasting to UI WebSocket

## ZeroClaw Daemon Flags

`zeroclaw daemon` only accepts two flags:
```bash
zeroclaw daemon [--host <HOST>] [--port <PORT>]
```

**There is no `--session`, `--soul`, `--identity`, or `--config` flag.** All agent configuration comes exclusively from `config.toml` in the working directory (`cwd`). This is why the `cwd` option in `child_process.spawn()` is critical — ZeroClaw reads `zeroclaw.config.toml` from whatever directory it is started in.

## Actual File Structure Per Agent Workspace

```
{workspacePath}/
├── zeroclaw.config.toml         ← Generated by AES before spawn
├── identity.json                ← AIEOS v1.1 (referenced from config.toml)
├── soul.md                      ← Agent soul (referenced from config.toml)
├── state/
│   ├── costs.jsonl              ← LLM cost records (watched by AnalyticsService)
│   └── runtime-trace.jsonl     ← Tool call / model reply traces (archived to MongoDB)
└── memory/
    └── brain.db                 ← SQLite hybrid vector+FTS memory (NEVER delete)
```

> **Important**: The PRD mentions `session.jsonl`, `transcript.jsonl`, and `usage.json` — **none of these files exist in ZeroClaw**. The actual equivalents are `memory/brain.db` (session), `state/runtime-trace.jsonl` (transcript), and `state/costs.jsonl` (usage).

## Session Recovery

ZeroClaw uses `memory/brain.db` (SQLite with FTS5 + vector embeddings) for persistent memory. Sessions are scoped by a `session_id` column in the `memories` table. If an agent process is killed:
1. NestJS re-spawns `zeroclaw daemon --host 127.0.0.1 --port {gatewayPort}` in the same `workspacePath`
2. ZeroClaw automatically loads `memory/brain.db` from the workspace directory
3. Agent continues with full memory context — no extra flag needed

## References

- PRD.md §2.1 (ZeroClaw Core Kernel)
- PRD.md §2.2 (Agent Instancing)
- `knowledge-base/01-architecture.md`
- `knowledge-base/05-communication-protocols.md`
